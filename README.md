# tlsbin

`tlsbin` is a simple tool for inspecting and debugging TLS (Transport Layer Security) negotiations.
This application provides a TLS server that allows you to easily observe the details of the TLS handshake from any client.
It is especially useful for testing supported TLS versions, cipher suites, ALPN protocols, ECH (Encrypted Client Hello), and mTLS configurations.

`tlsbin` also includes helper commands to generate the necessary cryptographic materials (CAs, certificates, ECH keys) for setting up advanced TLS test scenarios.

## Features

- **TLS Inspection Server**: Start a TLS server with customizable address, protocol, and cipher settings.
- **Detailed Handshake Information**: View detailed TLS handshake dumps (including Client Hello) via an HTTP request.
- **Certificate Generation**: Built-in commands to create your own Certificate Authority (CA) and sign server/client certificates.
- **ECH Support**: Generate static ECH (Encrypted Client Hello) keys and configure the server to use them.
- **mTLS Testing**: Easily test mTLS setups by generating CAs and client certificates and configuring the server to require them.

## Installation
```
go install github.com/haccht/tlsbin@latest
```

## Usage

`tlsbin` uses a subcommand structure.

```
$ tlsbin --help
Usage:
  tlsbin [OPTIONS] <run|gen-ech|gen-ca|gen-cert>

Available commands:
  run        Run the TLS inspection server
  gen-ech    Generate a new static ECH key and config
  gen-ca     Generate a new CA certificate and key
  gen-cert   Generate a new certificate signed by a CA
```

### `run` command

This command starts the main TLS inspection server. If no subcommand is specified, `run` is used by default.

```
$ tlsbin run [OPTIONS]
```
The server will start, and you can send a request to it (e.g., with `curl`) to receive a JSON dump of the client's TLS handshake information.

**Example:**
```
# Start the server
$ tlsbin run

# In another terminal, make a request
$ curl -s -k https://127.0.0.1:8080
{
  "client_hello": { ... },
  "mTLS": { ... },
  "negotiated": { ... }
}
```

**Common `run` options:**
- `--addr`: Server address (default: `127.0.0.1:8080`).
- `--tls-crt`, `--tls-key`: Path to your TLS certificate and key. If not provided, a self-signed certificate for `localhost` is generated on the fly.
- `--enable-mtls`: Enable mTLS. The server will request a client certificate.
- `--tls-ca`: Path to a CA certificate to verify client certificates against. Implies `--enable-mtls`.
- `--enable-ech`: Enable Encrypted Client Hello. Generates a temporary key by default.
- `--ech-key`, `--ech-config-list`: Use a static ECH private key and config list (generated by the `gen-ech` command).

---

### Certificate and Key Generation

#### 1. `gen-ca`

Create a new root Certificate Authority (CA).

```
$ tlsbin gen-ca --common-name="My Test CA"
2025/08/18 21:30:00 wrote CA certificate to ca.crt
2025/08/18 21:30:00 wrote CA private key to ca.key
```
This creates `ca.crt` and `ca.key`.

#### 2. `gen-cert`

Create a new certificate signed by your CA.

**For a server certificate:**
```
$ tlsbin gen-cert --common-name="myserver.dev" --dns-name="myserver.dev" --dns-name="*.myserver.dev"
2025/08/18 21:31:00 wrote certificate to server.crt
2025/08/18 21:31:00 wrote private key to server.key
```

**For a client certificate:**
```
$ tlsbin gen-cert --common-name="my-client" --client --out-cert=client.crt --out-key=client.key
2025/08/18 21:32:00 wrote certificate to client.crt
2025/08/18 21:32:00 wrote private key to client.key
```
This uses `ca.crt` and `ca.key` by default to sign the new certificate.

---

### ECH (Encrypted Client Hello)

#### `gen-ech`

Generate a static ECH key pair and the corresponding DNS record info.

```
$ tlsbin gen-ech --public-name="ech.example.com"
Generating new ECH key pair...

Successfully generated ECH keys.
---------------------------------
Add the following flags to the 'run' command to use this static key:

  --ech-key="..." \
  --ech-config-list="..."

Add the following HTTPS record to your DNS for the public name:

  ech.example.com. IN HTTPS 1 . ech="..."
---------------------------------
```
You can then pass the generated `--ech-key` and `--ech-config-list` values to the `run` command to start the server with a stable ECH configuration.
